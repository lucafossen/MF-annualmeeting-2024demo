<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ article.title }} - Recommendations</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden {
            display: none;
        }

        .no-coloring .highlighted-recommendation,
        .no-coloring .normal-recommendation {
            background-color: transparent !important;
        }

        .toggle-container {
            /* position: fixed; */
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #5a5a5a;
            color: white;
            border-radius: 5px;
            border: none;
            text-align: center;
            transition: background-color 0.3s;
        }

        .toggle-button:hover {
            background-color: #0056b3;
        }

        .toggle-container input[type="checkbox"] {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="/" class="no-underline-link">
                <img src="https://mediafutures.no/wp-content/uploads/tv2_scaled.png" alt="TV 2 Logo" class="tv2-logo">
                <h1>LLMs as Journalists</h1>
                <p>Tool for journalists and editors - Helping them find related articles to their story</p>
            </a>
        </div>
        <button id="susButton" disabled style="background-color: #d3d3d3; cursor: not-allowed;">
            Proceed to SUS
        </button>
        <h2>Main article:</h2>

        <div class="main-article-item">
            <a href="https://tv2.no/a/{{ article.uuid }}" class="external-link-button">Visit original article on TV 2</a>
            <div class="main-article-content">
                <h1 class="main-article-title">{{ article.title }}</h1>
                <p class="article-byline">{{ article.byline | join(', ') }}</p>
                <p class="article-metadata">Published on {{ article.creation_date }} in {{ article.section }}</p>
                <img src="{{ article.image_url or 'https://via.placeholder.com/150' }}" alt="{{ article.title }}">
                <p class="article-lead-text">{{ article.lead_text }}</p>
                <div class="article-full-text">
                    <!-- Just showing the first 400 chars for now -->
                    {{ article.body_text[:400]+"..." | safe }} <a href="https://tv2.no/a/{{ article.uuid }}"
                        target="_blank">Read more (opens in new tab)</a>
                </div>
            </div>
        </div>

        <!-- Wrap the main content in a container to control coloring -->
        <div id="main-content">
            <div class="small-articles-section">
                <h2>AI Recommendations for Related Articles:</h2>
                <p id="color-explainer"><i>Articles that were also picked by editors are highlighted in green</i></p>
                <ul class="small-articles">
                    {% for rec in recommendations %}
                    <li class="recommendation-item normal-recommendation">
                        <a href="{{ url_for('recommendation', article_id=article.uuid, recommendation_id=rec.uuid) }}">
                            <img src="{{ rec.image_url or 'https://via.placeholder.com/150' }}" alt="No image">
                            <div class="recommendation-content">
                                <span class="recommendation-title">{{ rec.title }}</span>
                                <p class="recommendation-description">{{ rec.byline | join(', ') }}<br>{{ rec.creation_date }}</p>
                            </div>
                            </a>

                            <div class="feedback-section">
                            <label for="rating-{{ rec.uuid }}">Rate (1–10):</label>
                            <select class="rating-input" id="rating-{{ rec.uuid }}" data-article-id="{{ article.uuid }}" data-rec-id="{{ rec.uuid }}">
                                <option value="">-- Select --</option>
                                {% for i in range(1, 11) %}
                                <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>


                            <br>
                            <br>

                            <label for="feedback-comment-{{ rec.uuid }}">Comment:</label>
                            <textarea
                                class="feedback-comment"
                                id="feedback-comment-{{ rec.uuid }}"
                                data-article-id="{{ article.uuid }}"
                                data-rec-id="{{ rec.uuid }}"
                                placeholder="Your thoughts..."
                            ></textarea>

                            <button
                                class="submit-feedback"
                                data-article-id="{{ article.uuid }}"
                                data-rec-id="{{ rec.uuid }}"
                            >
                                Submit
                            </button>
                            </div>
                        </li>
                    {% else %}
                    <li>No recommendations available for this article.</li>
                    {% endfor %}
                </ul>
            </div>

        </div>
        <a href="{{ url_for('home') }}" class="back-link">Back to Home</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Attach event listeners to the new "Submit" buttons
            const feedbackButtons = document.querySelectorAll('.submit-feedback');
            feedbackButtons.forEach(function (button) {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const articleId = this.getAttribute('data-article-id');
                    const recId = this.getAttribute('data-rec-id');

                    // Retrieve the rating and text from their respective elements
                    const ratingSelect = document.getElementById(`rating-${recId}`);
                    const commentField = document.getElementById(`feedback-comment-${recId}`);

                    const ratingValue = ratingSelect.value;
                    const commentValue = commentField.value.trim();

                    // Simple front-end check; ensure a rating was chosen
                    if (!ratingValue) {
                        alert('Please select a rating (1–10) before submitting.');
                        return;
                    }

                    // Send feedback to the server
                    sendFeedback(articleId, recId, ratingValue, commentValue);

                    // Optionally clear fields
                    ratingSelect.value = '';
                    commentField.value = '';
                });
            });

            // Function to send feedback to the backend
            function sendFeedback(articleId, recommendationId, rating, comment) {
                fetch('{{ url_for('feedback') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'article_id': articleId,
                        'recommendation_id': recommendationId,
                        'rating': rating,
                        'comment': comment
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Feedback submitted:', data);
                        updateSusButton(); // Update SUS button after feedback is sent
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }

            // Function to update the SUS button based on the current rating count
            function updateSusButton() {
                const susButton = document.getElementById('susButton');

                // Fetch the user's current rating count
                fetch('/get_rating_count')
                .then(response => response.json())
                .then(data => {
                    const count = data.count || 0;
                    // Set the threshold for enabling the SUS button
                    const threshold = 5;

                    if (count >= threshold) {
                        // Enable the button
                        susButton.disabled = false;
                        susButton.style.backgroundColor = '#0077cc';
                        susButton.style.cursor = 'pointer';
                        susButton.innerText = `Proceed to SUS`;

                        // When clicked, direct user to SUS page
                        susButton.addEventListener('click', () => {
                            window.location.href = '/sus';
                        });

                    } else {
                        // If below threshold, optionally show how many more needed
                        susButton.innerText = `Please rate ${threshold - count} more to unlock SUS`;
                    }
                })
                .catch(error => {
                    console.error('Unable to fetch rating count:', error);
                });
            }

            // Initial call to update the SUS button on page load
            updateSusButton();
        });
    </script>

</body>
</html>