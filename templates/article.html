{% from "partials/progress_bar.html" import render_progress_bar %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spørreskjema: {{ article.title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden {
            display: none;
        }

        .no-coloring .highlighted-recommendation,
        .no-coloring .normal-recommendation {
            background-color: transparent !important;
        }

        .toggle-container {
            /* position: fixed; */
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #5a5a5a;
            color: white;
            border-radius: 5px;
            border: none;
            text-align: center;
            transition: background-color 0.3s;
        }

        .toggle-button:hover {
            background-color: #0056b3;
        }

        .toggle-container input[type="checkbox"] {
            display: none;
        }

        /* Start of new styles to modernize dropdowns and text boxes */
        select.rating-input, textarea.feedback-comment {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #f9f9f9;
        }
        select.rating-input:focus, textarea.feedback-comment:focus {
            border-color: #66afe9;
            box-shadow: 0 0 8px rgba(102,175,233,0.6);
            outline: none;
            background-color: #fff;
        }
        .recommendation-item {
            display: flex;
            flex-direction: column;
            min-height: 300px; /* adjust this value as needed */
        }

        .feedback-section {
            margin-top: auto;
        }
        /* New styles for the scroll hint */
        .scroll-hint {
            position: fixed;
            top: 40%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1100;
        }
        .scroll-hint.visible {
            opacity: 1;
        }
        .scroll-hint .arrow {
            font-size: 24px;
            margin-right: 8px;
        }
        /* Overlay styling */
        #instructionsOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* hidden by default */
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
        }
        .overlay-content {
            background-color: #fff;
            width: 80%;
            max-width: 600px;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
        }
        .overlay-content button {
            display: inline-block;
            margin-top: 20px;
            background-color: #0077cc;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .overlay-content button:hover {
            background-color: #005fa3;
        }

        /* Container for the help icon and tooltip */
        #help-icon-container {
            position: relative;
            float: left;
            margin: 10px;
            z-index: 1000;
            text-align: center;
        }

        /* Styling for the help icon */
        #help-icon {
            display: inline-block;
            background-color: #007bff;
            color: #fff;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* Tooltip initially hidden */
        #help-tooltip {
            display: none;
            position: absolute;
            top: 100%; /* Positions the tooltip directly below the help icon container */
            left: 0;   /* Can be adjusted for horizontal alignment */
            margin-top: 5px; /* Provides some spacing between icon and tooltip */
            background-color: #fff;
            color: #333;
            padding: 10px;
            width: 400px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.15);
            font-size: 14px;
        }

        /* Show tooltip on hover */
        #help-icon-container:hover #help-tooltip {
            display: block;
        }
    </style>
</head>

<body>
    {{ render_progress_bar(progress) }}
    <!-- Scroll hint container -->
    <div id="scrollHint" class="scroll-hint">
        <span class="arrow">&#8675;</span>
        <span>Bla ned for å vurdere AI-anbefalinger</span>
    </div>
    <!-- Overlay (hidden on subsequent visits) -->
    <div id="instructionsOverlay">
        <div class="overlay-content">
            <h2>Velkommen!</h2>
            <p>Vi er forskere fra MediaFutures, og vi prøver ut en ny metode for å anbefale <b>relaterte artikler</b> for journalister og redaktører. Du kommer til å gi oss ordentlig verdifull tilbakemelding på kvaliteten av disse anbefalingene.</p>
            <p>
                Slik fullfører du undersøkelsen:
            </p>
            <ol>
                <li>Hver side viser en nyhetssak samt AI-anbefalte artikler basert på den aktuelle artikkelen. Trykk på "<b>forrige</b>" og "<b>neste</b>"-knappene på høyre og venstre side for å bla gjennom de.</li><br>
                <li>For hver anbefaling, vurder hvor <b>relevant</b> den er er sammenlignet med den originale artikkelen. Vurder mellom 1 til 10, hvor <b>1</b> er <b>Helt irrelevant</b> og <b>10</b> er <b>Helt relevant</b>.</li><br>
                <li>Hvis du gir en lav score, er det til stor hjelp om du legger til en valgfri kommentar for å forklare!</li><br>
                <li>Når du har minst <b>20</b> vurderinger, kan du gå videre til siste trinn (tar ca. 2 minutter) ved å klikke på "Gå til spørreskjema" knappen nederst. Men du må gjerne fortsette å vurdere artikler! Jo mer tilbakemelding vi får, jo bedre!</li><br>
            </ol>

            <form id="companyForm">
                <label for="companyInput"><b>Et raskt kontrollspørsmål: Hvilket selskap jobber du for?</b></label><br>
                <input
                    type="text"
                    id="companyInput"
                    name="company"
                    placeholder="Skriv inn selskapets navn"
                    style="width: 100%; max-width: 300px;"
                    required
                />
                <br><br>
                <button type="submit" id="overlaySubmitBtn">
                    Forstått
                </button>
            </form>
        </div>
    </div>
    <div class="container">
        <!-- Help Icon Container -->
        <div id="help-icon-container">
            <span id="help-icon">?</span>
            <div id="help-tooltip">
                <h3>
                    Slik fullfører du undersøkelsen:
                </h3>
                <ol>
                    <li>Hver side viser en nyhetssak samt AI-anbefalte artikler basert på den aktuelle artikkelen. Trykk på "<b>forrige</b>" og "<b>neste</b>"-knappene på høyre og venstre side for å bla gjennom de.</li><br>
                    <li>For hver anbefaling, vurder hvor <b>relevant</b> den er er sammenlignet med den originale artikkelen. Vurder mellom 1 til 10, hvor <b>1</b> er <b>Helt irrelevant</b> og <b>10</b> er <b>Helt relevant</b>.</li><br>
                    <li>Hvis du gir en lav score, er det til stor hjelp om du legger til en valgfri kommentar for å forklare!</li><br>
                    <li>Når du har minst <b>20</b> vurderinger, kan du gå videre til siste trinn (tar ca. 2 minutter) ved å klikke på "Gå til spørreskjema" knappen nederst. Men du må gjerne fortsette å vurdere artikler! Jo mer tilbakemelding vi får, jo bedre!</li><br>
                </ol>
            </div>
        </div>
        <div class="header">
            <a href="/" class="no-underline-link">
                <h1>Undersøkelse: AI For Journalister</h1>
                <!-- <p>Verktøy for journalister og redaktører - Hjelper dem med å finne relaterte artikler til deres historie</p> -->
            </a>
        </div>
        <h2>Hovedartikkel:</h2>

        <div class="main-article-item" style="display: flex; align-items: flex-start;">
            <img src="{{ article.image_url or 'https://via.placeholder.com/150' }}" alt="{{ article.title }}">
            <div class="main-article-content" >
                <div>
                    <a href="https://tv2.no/a/{{ article.uuid }}" target="_blank">
                        <h1 class="main-article-title">{{ article.title }}</h1>
                    </a>
                    <br>
                    <!-- <p class="article-byline">{{ article.byline | join(', ') }}</p> -->
                    <!-- <p class="article-metadata">Published on {{ article.creation_date }} in {{ article.section }}</p> -->
                    <p class="article-lead-text">{{ article.lead_text }}</p>
                    <div class="article-full-text">
                        <!-- Just showing the first 400 chars for now -->
                        {{ article.body_text[:400]+"..." | safe }} <a href="https://tv2.no/a/{{ article.uuid }}"
                            target="_blank">Les mer (åpnes i ny fane)</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wrap the main content in a container to control coloring -->
        <div id="main-content">
            <div class="small-articles-section">
                <h2>AI-anbefalinger for relaterte artikler:</h2>
                <ul class="small-articles">
                    {% for rec in recommendations %}
                    <li class="recommendation-item normal-recommendation">
                        <a href="https://tv2.no/a/{{ rec.uuid }}" target="_blank">
                            <img src="{{ rec.image_url or 'https://via.placeholder.com/150' }}" alt="No image">
                            <div class="recommendation-content">
                                <span class="recommendation-title">{{ rec.title }}</span>
                                <!-- Should show "days since", "x days older" or somehitng like that -->
                            </div>
                        </a>

                        <span class="recommendation-age">{{ rec.recommendation_age.capitalize() }} eldre enn original</span>
                        <span class="recommendation-lead-text">{{ rec.lead_text }}</span>

                        <div class="feedback-section" style="background-color: #363a3c;">
                        <br>
                            <label for="rating-{{ rec.uuid }}" style="color: #effeff;">Vurder (1–10):</label>
                            <select class="rating-input" id="rating-{{ rec.uuid }}" data-article-id="{{ article.uuid }}"
                                data-rec-id="{{ rec.uuid }}">
                                <option value="">-- Velg --</option>
                                    // Start of Selection
                                    {% for i in range(1, 11) %}
                                        {% if i == 1 %}
                                            <option value="{{ i }}">{{ i }} (helt irrelevant)</option>
                                        {% elif i == 5 %}
                                            <option value="{{ i }}">{{ i }} (litt relevant)</option>
                                        {% elif i == 10 %}
                                            <option value="{{ i }}">{{ i }} (helt relevant)</option>
                                        {% else %}
                                            <option value="{{ i }}">{{ i }}</option>
                                        {% endif %}
                                    {% endfor %}
                            </select>


                            <br>
                            <br>

                            <label for="feedback-comment-{{ rec.uuid }}" style="color: #effeff;"">Kommentar:</label>
                            <textarea class="feedback-comment" id="feedback-comment-{{ rec.uuid }}"
                                data-article-id="{{ article.uuid }}" data-rec-id="{{ rec.uuid }}"
                                placeholder="Dine tanker... (valgfritt)"></textarea>
                            <br>
                            <br>
                        </div>
                    </li>
                    {% else %}
                    <li>Ingen anbefalinger funnet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Single button to submit all feedback at once -->
        <button id="submitAll" class="btn">Send inn vurdering</button>

        <!-- Display rating status -->
        <p id="ratingStatus"></p>

        <button id="susButton" class="btn" disabled style="background-color: #d3d3d3; cursor: not-allowed;">
            Fortsett til spørreskjema
        </button>

        <!-- <a href="{{ url_for('home') }}" class="back-link">Back to Home</a> -->
    </div>

    <script>
        // Show overlay on the first visit
        window.addEventListener('load', () => {
                if (!localStorage.getItem('shownOverlay')) {
                    document.getElementById('instructionsOverlay').style.display = 'block';
                }
            });
        // Move the startHintTimer function to global scope so it can be accessed by hideOverlay()
        function startHintTimer() {
            const scrollHint = document.getElementById('scrollHint');
            const hintAlreadyShown = localStorage.getItem('scrollHintShown');

            function hasScrolledSmallArticles() {
                const smallArticlesSection = document.querySelector('.small-articles-section');
                if (smallArticlesSection) {
                    const rect = smallArticlesSection.getBoundingClientRect();
                    return rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
                }
                return false;
            }

            if (!hintAlreadyShown) {
                // After 5 seconds, if the user hasn't scrolled yet, show the hint.
                const hintTimeout = setTimeout(() => {
                    if (!hasScrolledSmallArticles()) {
                        scrollHint.classList.add('visible');
                    }
                }, 5000);

                // When user scrolls, hide the hint (if visible) and set a flag.
                function onUserScroll() {
                    if (hasScrolledSmallArticles()) {
                        scrollHint.classList.remove('visible');
                        localStorage.setItem('scrollHintShown', 'true');
                        window.removeEventListener('scroll', onUserScroll);
                    }
                }
                window.addEventListener('scroll', onUserScroll);
            }
        }

        function hideOverlay() {
            document.getElementById('instructionsOverlay').style.display = 'none';
            localStorage.setItem('shownOverlay', 'true');

            // Start the hint timer after the overlay is closed
            startHintTimer();
        }

        var ratingThreshold = 20;
        document.addEventListener('DOMContentLoaded', function () {
            const susButton = document.getElementById('susButton');
            const submitAllButton = document.getElementById('submitAll');
            const ratingStatus = document.getElementById('ratingStatus');
            const companyForm = document.getElementById('companyForm');

            if (companyForm) {
                companyForm.addEventListener('submit', function (event) {
                    event.preventDefault(); // Prevent actual form submission
                    const companyValue = document.getElementById('companyInput').value.trim();

                    fetch('/store_company', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ company: companyValue })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Company info saved:', data);
                        // Once saved, hide the overlay and do not reload the page
                        hideOverlay();
                    })
                    .catch(err => {
                        console.error('Error storing company info:', err);
                        // Even if error, you could choose to hide the overlay or not
                        hideOverlay();
                    });
                });
            }

            submitAllButton.addEventListener('click', function (event) {
                event.preventDefault();

                // Gather all feedback
                const recommendations = document.querySelectorAll('.recommendation-item');
                let feedbackData = [];

                recommendations.forEach((recItem) => {
                    const ratingSelect = recItem.querySelector('.rating-input');
                    const commentField = recItem.querySelector('.feedback-comment');

                    const articleId = ratingSelect.getAttribute('data-article-id');
                    const recId = ratingSelect.getAttribute('data-rec-id');
                    const ratingValue = ratingSelect.value;
                    const commentValue = commentField.value.trim();

                    // Check if user selected a rating
                    if (ratingValue) {
                        feedbackData.push({
                            article_id: articleId,
                            recommendation_id: recId,
                            rating: ratingValue,
                            comment: commentValue
                        });
                    }
                });

                if (feedbackData.length === 0) {
                    alert('Please select at least one rating before submitting.');
                    return;
                }

                // Send all feedback in a single batch of fetch calls
                feedbackData.forEach((feedback) => {
                    fetch('{{ url_for('feedback') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(feedback)
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Feedback submitted:', data);
                            updateSusButton();
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
                });

                // Reset the fields
                    recommendations.forEach((recItem) => {
                        const ratingSelect = recItem.querySelector('.rating-input');
                        const commentField = recItem.querySelector('.feedback-comment');

                        // Only reset if a rating was selected
                        if (ratingSelect.value) {
                            ratingSelect.value = '';
                            commentField.value = '';
                        }
                    });
            });

            function updateSusButton() {
                fetch('/get_rating_count')
                    .then(response => response.json())
                    .then(data => {
                        const count = data.count || 0;

                        if (count >= ratingThreshold) {
                            ratingStatus.innerText = `Tusen takk! Du har vurdert ${count} artikler. Fortsett gjerne å vurdere, eller gå videre til spørreskjemaet.`;
                            susButton.disabled = false;
                            susButton.style.backgroundColor = '#00b613';
                            susButton.style.cursor = 'pointer';
                            susButton.innerText = `Gå videre til spørreskjemaet`;
                            susButton.addEventListener('click', () => {
                                window.location.href = '/sus';
                            });
                        } else {
                            susButton.innerText = `Vennligst vurder ${ratingThreshold - count} til for å låse opp spørreskjemaet`;
                        }
                    })
                    .catch(error => {
                        console.error('Kan ikke hente vurderingstelling:', error);
                    });
            }

            // Initial call to update the SUS button on page load
            updateSusButton();
        });
    </script>
    {% if use_predetermined_flow %}
        <!-- Inline variables for predetermined navigation -->
        <script>
            console.log("Using predetermined navigation flow");
            // Use the server-generated list passed as a variable
            var predeterminedArticles = {{ predetermined_articles|tojson }};  // {{ edit_7 }}
            // Find the index of the current article using its uuid
            var currentIndex = predeterminedArticles.indexOf("{{ article['uuid'] }}");
        </script>
        <!-- Load additional JS file for navigation enhancements -->
        <script src="{{ url_for('static', filename='predetermined.js') }}"></script>
    {% else %}
        <script>
            console.log("Not using predetermined navigation flow");
        </script>
    {% endif %}
</body>

</html>