<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ article.title }} - Recommendations</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .hidden {
            display: none;
        }

        .no-coloring .highlighted-recommendation,
        .no-coloring .normal-recommendation {
            background-color: transparent !important;
        }

        .toggle-container {
            /* position: fixed; */
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #5a5a5a;
            color: white;
            border-radius: 5px;
            border: none;
            text-align: center;
            transition: background-color 0.3s;
        }

        .toggle-button:hover {
            background-color: #0056b3;
        }

        .toggle-container input[type="checkbox"] {
            display: none;
        }

        /* Start of new styles to modernize dropdowns and text boxes */
        select.rating-input, textarea.feedback-comment {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #f9f9f9;
        }
        select.rating-input:focus, textarea.feedback-comment:focus {
            border-color: #66afe9;
            box-shadow: 0 0 8px rgba(102,175,233,0.6);
            outline: none;
            background-color: #fff;
        }
        .recommendation-item {
            display: flex;
            flex-direction: column;
            min-height: 300px; /* adjust this value as needed */
        }

        .feedback-section {
            margin-top: auto;
        }
        /* New styles for the scroll hint */
        .scroll-hint {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1100;
        }
        .scroll-hint.visible {
            opacity: 1;
        }
        .scroll-hint .arrow {
            font-size: 24px;
            margin-right: 8px;
        }
    </style>
</head>

<body>
    <!-- Scroll hint container -->
    <div id="scrollHint" class="scroll-hint">
        <span class="arrow">&#8675;</span>
        <span>Scroll down to rate AI recommendations</span>
    </div>
    <div class="container">
        <div class="header">
            <a href="/" class="no-underline-link">
                <h1>AI supporting Journalists</h1>
                <p>Tool for journalists and editors - Helping them find related articles to their story</p>
            </a>
        </div>
        <h2>Main article:</h2>

        <div class="main-article-item">
            <div class="main-article-content">
                <h1 class="main-article-title">{{ article.title }}</h1>
                <br>
                <!-- <p class="article-byline">{{ article.byline | join(', ') }}</p> -->
                <!-- <p class="article-metadata">Published on {{ article.creation_date }} in {{ article.section }}</p> -->
                <img src="{{ article.image_url or 'https://via.placeholder.com/150' }}" alt="{{ article.title }}">
                <p class="article-lead-text">{{ article.lead_text }}</p>
                <div class="article-full-text">
                    <!-- Just showing the first 400 chars for now -->
                    {{ article.body_text[:400]+"..." | safe }} <a href="https://tv2.no/a/{{ article.uuid }}"
                        target="_blank">Read more (opens in new tab)</a>
                </div>
            </div>
        </div>

        <!-- Wrap the main content in a container to control coloring -->
        <div id="main-content">
            <div class="small-articles-section">
                <h2>AI Recommendations for Related Articles:</h2>
                <ul class="small-articles">
                    {% for rec in recommendations %}
                    <li class="recommendation-item normal-recommendation">
                        <a href="{{ url_for('recommendation', article_id=article.uuid, recommendation_id=rec.uuid) }}">
                            <img src="{{ rec.image_url or 'https://via.placeholder.com/150' }}" alt="No image">
                            <div class="recommendation-content">
                                <span class="recommendation-title">{{ rec.title }}</span>
                                <!-- Should show "days since", "x days older" or somehitng like that -->
                            </div>
                        </a>

                        <span class="recommendation-age">Published {{ rec.recommendation_age }} earlier</span>
                        <span class="recommendation-lead-text">{{ rec.lead_text }}</span>

                        <div class="feedback-section" style="background-color: #363a3c;">
                        <br>
                            <label for="rating-{{ rec.uuid }}" style="color: #effeff;">Rate (1â€“10):</label>
                            <select class="rating-input" id="rating-{{ rec.uuid }}" data-article-id="{{ article.uuid }}"
                                data-rec-id="{{ rec.uuid }}">
                                <option value="">-- Select --</option>
                                    // Start of Selection
                                    {% for i in range(1, 11) %}
                                        {% if i == 1 %}
                                            <option value="{{ i }}">{{ i }} (helt irrelevant)</option>
                                        {% elif i == 5 %}
                                            <option value="{{ i }}">{{ i }} (litt relevant)</option>
                                        {% elif i == 10 %}
                                            <option value="{{ i }}">{{ i }} (helt relevant)</option>
                                        {% else %}
                                            <option value="{{ i }}">{{ i }}</option>
                                        {% endif %}
                                    {% endfor %}
                            </select>


                            <br>
                            <br>

                            <label for="feedback-comment-{{ rec.uuid }}" style="color: #effeff;"">Comment:</label>
                            <textarea class="feedback-comment" id="feedback-comment-{{ rec.uuid }}"
                                data-article-id="{{ article.uuid }}" data-rec-id="{{ rec.uuid }}"
                                placeholder="Your thoughts... (optional)"></textarea>
                            <br>
                            <br>
                        </div>
                    </li>
                    {% else %}
                    <li>No recommendations available for this article.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Single button to submit all feedback at once -->
        <button id="submitAll" class="btn">Submit feedback</button>

        <button id="susButton" class="btn" disabled style="background-color: #d3d3d3; cursor: not-allowed;">
            Proceed to SUS
        </button>

        <a href="{{ url_for('home') }}" class="back-link">Back to Home</a>
    </div>

    <script>
        var ratingThreshold = 5; // already defined
        document.addEventListener('DOMContentLoaded', function () {
            const susButton = document.getElementById('susButton');
            const submitAllButton = document.getElementById('submitAll');
            const scrollHint = document.getElementById('scrollHint');

            // Check localStorage flag for the hint
            const hintAlreadyShown = localStorage.getItem('scrollHintShown');

            function hasScrolledSmallArticles() {
                const smallArticlesSection = document.querySelector('.small-articles-section');
                if (smallArticlesSection) {
                    const rect = smallArticlesSection.getBoundingClientRect();
                    if (rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)) {
                        return true;
                    }
                }
                return false;
            }
            // Only set up the hint if the flag is not set
            if (!hintAlreadyShown) {
                // After 5 seconds, if the user hasn't scrolled yet, show the hint.
                const hintTimeout = setTimeout(() => {
                    if (!hasScrolledSmallArticles()) {
                        scrollHint.classList.add('visible');
                    }
                }, 5000);

                // When user scrolls, hide the hint (if visible) and set a flag.
                function onUserScroll() {
                    if (hasScrolledSmallArticles()) {
                        scrollHint.classList.remove('visible');
                        localStorage.setItem('scrollHintShown', 'true');
                        window.removeEventListener('scroll', onUserScroll);
                    }
                }
                window.addEventListener('scroll', onUserScroll);
            }
            submitAllButton.addEventListener('click', function (event) {
                event.preventDefault();

                // Gather all feedback
                const recommendations = document.querySelectorAll('.recommendation-item');
                let feedbackData = [];

                recommendations.forEach((recItem) => {
                    const ratingSelect = recItem.querySelector('.rating-input');
                    const commentField = recItem.querySelector('.feedback-comment');

                    const articleId = ratingSelect.getAttribute('data-article-id');
                    const recId = ratingSelect.getAttribute('data-rec-id');
                    const ratingValue = ratingSelect.value;
                    const commentValue = commentField.value.trim();

                    // Check if user selected a rating
                    if (ratingValue) {
                        feedbackData.push({
                            article_id: articleId,
                            recommendation_id: recId,
                            rating: ratingValue,
                            comment: commentValue
                        });
                    }
                });

                if (feedbackData.length === 0) {
                    alert('Please select at least one rating before submitting.');
                    return;
                }

                // Send all feedback in a single batch of fetch calls
                feedbackData.forEach((feedback) => {
                    fetch('{{ url_for('feedback') }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(feedback)
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Feedback submitted:', data);
                            updateSusButton();
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                        });
                });

                // Reset the fields
                    // Start of Selection
                    recommendations.forEach((recItem) => {
                        const ratingSelect = recItem.querySelector('.rating-input');
                        const commentField = recItem.querySelector('.feedback-comment');

                        // Only reset if a rating was selected
                        if (ratingSelect.value) {
                            ratingSelect.value = '';
                            commentField.value = '';
                        }
                    });
            });

            function updateSusButton() {
                fetch('/get_rating_count')
                    .then(response => response.json())
                    .then(data => {
                        const count = data.count || 0;

                        if (count >= ratingThreshold) {
                            susButton.disabled = false;
                            susButton.style.backgroundColor = '#00b613';
                            susButton.style.cursor = 'pointer';
                            susButton.innerText = `Proceed to SUS`;
                            susButton.addEventListener('click', () => {
                                window.location.href = '/sus';
                            });
                        } else {
                            susButton.innerText = `Please rate ${ratingThreshold - count} more to unlock SUS`;
                        }
                    })
                    .catch(error => {
                        console.error('Unable to fetch rating count:', error);
                    });
            }

            // Initial call to update the SUS button on page load
            updateSusButton();
        });
    </script>
</body>

</html>